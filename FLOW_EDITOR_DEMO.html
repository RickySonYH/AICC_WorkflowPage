<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AICC í”Œë¡œìš° ì—ë””í„° - ì¸í„°ë™í‹°ë¸Œ ë°ëª¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: #f9fafb;
      overflow: hidden;
    }

    .app-container {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* í—¤ë” */
    .header {
      background: white;
      padding: 16px 32px;
      border-bottom: 2px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
    .tab-nav {
      background: white;
      padding: 0 32px;
      display: flex;
      gap: 8px;
      border-bottom: 2px solid #e5e7eb;
    }

    .tab-button {
      padding: 12px 24px;
      border: none;
      background: none;
      color: #6b7280;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      position: relative;
      top: 2px;
    }

    .tab-button:hover {
      color: #5a6bfa;
    }

    .tab-button.active {
      color: #5a6bfa;
      border-bottom-color: #5a6bfa;
      font-weight: 600;
    }

    /* ë²„íŠ¼ */
    .button {
      padding: 10px 20px;
      border: 1px solid #d5d9e3;
      border-radius: 8px;
      background: #fff;
      color: #374151;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .button:hover {
      background: #f3f4f6;
    }

    .button-primary {
      background: #5a6bfa;
      color: white;
      border-color: #5a6bfa;
    }

    .button-primary:hover {
      background: #4c5fd5;
      box-shadow: 0 4px 12px rgba(90,107,250,0.3);
    }

    .button-secondary {
      background: #fff;
      color: #5a6bfa;
      border-color: #5a6bfa;
    }

    .button-secondary:hover {
      background: #eef1ff;
    }

    /* íƒ­ ì»¨í…ì¸  */
    .tab-content {
      display: none;
      flex: 1;
      overflow: hidden;
    }

    .tab-content.active {
      display: flex;
      flex-direction: column;
    }

    /* ì—ë””í„° ë ˆì´ì•„ì›ƒ */
    .editor-container {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .editor-toolbar {
      background: white;
      padding: 16px 32px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .toolbar-title {
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
    }

    .toolbar-actions {
      display: flex;
      gap: 12px;
    }

    /* ì‚¬ì´ë“œë°” */
    .sidebar {
      width: 300px;
      background: white;
      border-right: 2px solid #e5e7eb;
      overflow-y: auto;
      padding: 20px;
    }

    .sidebar-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #1f2937;
    }

    .node-palette {
      display: grid;
      gap: 12px;
    }

    .node-palette-item {
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      cursor: grab;
      transition: all 0.2s;
      background: white;
    }

    .node-palette-item:hover {
      border-color: #5a6bfa;
      box-shadow: 0 4px 12px rgba(90,107,250,0.15);
    }

    .node-palette-item:active {
      cursor: grabbing;
    }

    .node-palette-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .node-palette-desc {
      font-size: 12px;
      color: #6b7280;
    }

    /* ìº”ë²„ìŠ¤ */
    .canvas {
      flex: 1;
      position: relative;
      overflow: auto;
      background: #fafafa;
      background-image: 
        linear-gradient(#e5e7eb 1px, transparent 1px),
        linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
      background-size: 20px 20px;
    }

    .canvas-content {
      position: relative;
      min-width: 2000px;
      min-height: 1500px;
    }

    /* ë…¸ë“œ */
    .flow-node {
      position: absolute;
      width: 280px;
      background: white;
      border: 3px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      cursor: grab;
      transition: box-shadow 0.2s;
      user-select: none;
    }

    .flow-node:hover {
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .flow-node.selected {
      border-color: #5a6bfa;
      box-shadow: 0 8px 20px rgba(90,107,250,0.3);
    }

    .flow-node.dragging {
      cursor: grabbing;
      opacity: 0.8;
    }

    .node-header {
      padding: 12px 16px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .node-type-badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      color: white;
    }

    .node-type-start {
      background: #10b981;
    }

    .node-type-ai {
      background: #3b82f6;
    }

    .node-type-state {
      background: #f59e0b;
    }

    .node-type-end {
      background: #ef4444;
    }

    .node-type-workflow {
      background: #10b981;
    }

    .node-label {
      flex: 1;
      font-weight: 600;
      font-size: 14px;
      color: #1f2937;
    }

    .node-delete {
      background: none;
      border: none;
      color: #9ca3af;
      font-size: 18px;
      cursor: pointer;
      padding: 4px;
      line-height: 1;
    }

    .node-delete:hover {
      color: #ef4444;
    }

    .node-body {
      padding: 16px;
      font-size: 13px;
      color: #4b5563;
    }

    .node-config {
      background: #f9fafb;
      padding: 8px;
      border-radius: 6px;
      margin-top: 8px;
      font-size: 11px;
      color: #6b7280;
    }

    /* ì—°ê²°ì  */
    .node-connector {
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid white;
      cursor: crosshair;
      z-index: 10;
    }

    .node-connector.input {
      left: -8px;
      top: 50%;
      transform: translateY(-50%);
      background: #3b82f6;
    }

    .node-connector.output {
      right: -8px;
      top: 50%;
      transform: translateY(-50%);
      background: #10b981;
    }

    .node-connector:hover {
      transform: translateY(-50%) scale(1.3);
    }

    /* SVG ì—°ê²°ì„  */
    #connectionSvg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    .connection-line {
      stroke-width: 2;
      fill: none;
    }

    .connection-line.normal {
      stroke: #9ca3af;
    }

    .connection-line.conditional {
      stroke: #06b6d4;
      stroke-dasharray: 5,5;
    }

    .connection-line.temp {
      stroke: #5a6bfa;
      stroke-width: 3;
      stroke-dasharray: 5,5;
    }

    /* ìƒíƒœ í‘œì‹œ */
    .status-bar {
      background: white;
      border-top: 1px solid #e5e7eb;
      padding: 12px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: #6b7280;
    }

    .status-info {
      display: flex;
      gap: 20px;
    }

    /* ì•ˆë‚´ íŒ¨ë„ */
    .help-panel {
      position: fixed;
      bottom: 80px;
      right: 32px;
      background: white;
      border: 2px solid #5a6bfa;
      border-radius: 12px;
      padding: 20px;
      max-width: 320px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }

    .help-title {
      font-weight: 600;
      font-size: 14px;
      color: #5a6bfa;
      margin-bottom: 12px;
    }

    .help-list {
      list-style: none;
      padding: 0;
    }

    .help-list li {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 8px;
      padding-left: 20px;
      position: relative;
    }

    .help-list li:before {
      content: "â€¢";
      position: absolute;
      left: 8px;
      color: #5a6bfa;
      font-weight: bold;
    }

    .close-help {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      color: #9ca3af;
      font-size: 20px;
      cursor: pointer;
      line-height: 1;
    }

    .close-help:hover {
      color: #ef4444;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- í—¤ë” -->
    <div class="header">
      <h1>ğŸ¨ AICC í”Œë¡œìš° ì—ë””í„° - ì¸í„°ë™í‹°ë¸Œ ë°ëª¨</h1>
      <div class="header-actions">
        <button class="button" onclick="resetCanvas()">ì´ˆê¸°í™”</button>
        <button class="button button-secondary" onclick="toggleHelp()">ë„ì›€ë§</button>
        <button class="button button-primary" onclick="saveFlow()">ì €ì¥</button>
      </div>
    </div>

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="tab-nav">
      <button class="tab-button active" onclick="switchTab('workflow')">
        ì›Œí¬í”Œë¡œìš° ë¹Œë”
      </button>
      <button class="tab-button" onclick="switchTab('scenario')">
        ì‹œë‚˜ë¦¬ì˜¤ í”Œë¡œìš° ì—ë””í„°
      </button>
    </div>

    <!-- ì›Œí¬í”Œë¡œìš° ë¹Œë” -->
    <div id="workflowTab" class="tab-content active">
      <div class="editor-toolbar">
        <div class="toolbar-title">ì›Œí¬í”Œë¡œìš° ë¹Œë” - ê°œë³„ ë¸”ë¡ ë‚´ë¶€ ë…¸ë“œ í¸ì§‘</div>
        <div class="toolbar-actions">
          <button class="button" onclick="addNode('ai-answer')">+ AI ë‹µë³€</button>
          <button class="button" onclick="addNode('state-change')">+ ìƒíƒœ ë³€ê²½</button>
        </div>
      </div>
      <div class="editor-container">
        <div class="sidebar">
          <div class="sidebar-title">ë…¸ë“œ íŒ”ë ˆíŠ¸</div>
          <div class="node-palette">
            <div class="node-palette-item" draggable="true" data-node-type="start">
              <div class="node-palette-name" style="color: #10b981;">ğŸŸ¢ ì‹œì‘</div>
              <div class="node-palette-desc">ì›Œí¬í”Œë¡œìš° ì‹œì‘ì </div>
            </div>
            <div class="node-palette-item" draggable="true" data-node-type="ai-answer">
              <div class="node-palette-name" style="color: #3b82f6;">ğŸ’¬ AI ë‹µë³€</div>
              <div class="node-palette-desc">ê³ ê°ì—ê²Œ ë©”ì‹œì§€ ì „ë‹¬</div>
            </div>
            <div class="node-palette-item" draggable="true" data-node-type="state-change">
              <div class="node-palette-name" style="color: #f59e0b;">âš¡ ìƒíƒœ ë³€ê²½</div>
              <div class="node-palette-desc">ëŒ€í™” ìƒíƒœ ë³€ê²½</div>
            </div>
            <div class="node-palette-item" draggable="true" data-node-type="end">
              <div class="node-palette-name" style="color: #ef4444;">ğŸ”´ ì¢…ë£Œ</div>
              <div class="node-palette-desc">ì›Œí¬í”Œë¡œìš° ì¢…ë£Œì </div>
            </div>
          </div>
        </div>
        <div class="canvas" id="workflowCanvas">
          <svg id="workflowSvg"></svg>
          <div class="canvas-content" id="workflowContent">
            <!-- ë…¸ë“œë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
          </div>
        </div>
      </div>
    </div>

    <!-- ì‹œë‚˜ë¦¬ì˜¤ í”Œë¡œìš° ì—ë””í„° -->
    <div id="scenarioTab" class="tab-content">
      <div class="editor-toolbar">
        <div class="toolbar-title">ì‹œë‚˜ë¦¬ì˜¤ í”Œë¡œìš° ì—ë””í„° - ì›Œí¬í”Œë¡œìš° ì¡°í•©</div>
        <div class="toolbar-actions">
          <button class="button" onclick="addScenarioNode('workflow')">+ ì›Œí¬í”Œë¡œìš° ì¶”ê°€</button>
        </div>
      </div>
      <div class="editor-container">
        <div class="sidebar">
          <div class="sidebar-title">ì›Œí¬í”Œë¡œìš° ë¼ì´ë¸ŒëŸ¬ë¦¬</div>
          <div class="node-palette">
            <div class="node-palette-item" draggable="true" data-node-type="scenario-start">
              <div class="node-palette-name" style="color: #10b981;">ğŸ¬ ì‹œë‚˜ë¦¬ì˜¤ ì‹œì‘</div>
              <div class="node-palette-desc">ì´ˆê¸° ì¸ì‚¬ ì›Œí¬í”Œë¡œìš°</div>
            </div>
            <div class="node-palette-item" draggable="true" data-node-type="scenario-workflow">
              <div class="node-palette-name" style="color: #3b82f6;">ğŸ“¦ ì£¼ë¬¸ ì¡°íšŒ</div>
              <div class="node-palette-desc">ì´ì»¤ë¨¸ìŠ¤ ì£¼ë¬¸ ì¡°íšŒ</div>
            </div>
            <div class="node-palette-item" draggable="true" data-node-type="scenario-workflow">
              <div class="node-palette-name" style="color: #3b82f6;">ğŸ“¦ ë°˜í’ˆ ì•ˆë‚´</div>
              <div class="node-palette-desc">ì´ì»¤ë¨¸ìŠ¤ ë°˜í’ˆ ì²˜ë¦¬</div>
            </div>
            <div class="node-palette-item" draggable="true" data-node-type="scenario-workflow">
              <div class="node-palette-name" style="color: #8b5cf6;">ğŸ” ê³ ê° ì¸ì¦</div>
              <div class="node-palette-desc">ë³¸ì¸ í™•ì¸ ì ˆì°¨</div>
            </div>
            <div class="node-palette-item" draggable="true" data-node-type="scenario-end">
              <div class="node-palette-name" style="color: #ef4444;">ğŸ ì‹œë‚˜ë¦¬ì˜¤ ì¢…ë£Œ</div>
              <div class="node-palette-desc">ë§Œì¡±ë„ ì¡°ì‚¬ ë° ì¢…ë£Œ</div>
            </div>
          </div>
        </div>
        <div class="canvas" id="scenarioCanvas">
          <svg id="scenarioSvg"></svg>
          <div class="canvas-content" id="scenarioContent">
            <!-- ë…¸ë“œë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
          </div>
        </div>
      </div>
    </div>

    <!-- ìƒíƒœ ë°” -->
    <div class="status-bar">
      <div class="status-info">
        <span id="nodeCount">ë…¸ë“œ: 0ê°œ</span>
        <span id="connectionCount">ì—°ê²°: 0ê°œ</span>
        <span id="selectedNode">ì„ íƒ: ì—†ìŒ</span>
      </div>
      <div>
        <span>ë“œë˜ê·¸ë¡œ ë…¸ë“œ ì´ë™ | ì—°ê²°ì  í´ë¦­ìœ¼ë¡œ ì—°ê²° | Delete í‚¤ë¡œ ì‚­ì œ</span>
      </div>
    </div>
  </div>

  <!-- ë„ì›€ë§ íŒ¨ë„ -->
  <div class="help-panel" id="helpPanel" style="display: none;">
    <button class="close-help" onclick="toggleHelp()">âœ•</button>
    <div class="help-title">ğŸ’¡ ì‚¬ìš© ë°©ë²•</div>
    <ul class="help-list">
      <li>ì™¼ìª½ íŒ”ë ˆíŠ¸ì—ì„œ ë…¸ë“œë¥¼ ë“œë˜ê·¸í•˜ì—¬ ìº”ë²„ìŠ¤ì— ë†“ìœ¼ì„¸ìš”</li>
      <li>ë…¸ë“œë¥¼ ë“œë˜ê·¸í•˜ì—¬ ìœ„ì¹˜ë¥¼ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
      <li>ë…¸ë“œì˜ ì—°ê²°ì (ë™ê·¸ë¼ë¯¸)ì„ í´ë¦­í•˜ì—¬ ë‹¤ë¥¸ ë…¸ë“œì™€ ì—°ê²°í•˜ì„¸ìš”</li>
      <li>ë…¸ë“œë¥¼ í´ë¦­í•˜ë©´ ì„ íƒë˜ë©°, X ë²„íŠ¼ìœ¼ë¡œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
      <li>Delete í‚¤ë¥¼ ëˆŒëŸ¬ ì„ íƒëœ ë…¸ë“œë¥¼ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
      <li>íƒ­ì„ ì „í™˜í•˜ì—¬ ë‹¤ë¥¸ ì—ë””í„°ë¥¼ ì‹œí—˜í•´ë³´ì„¸ìš”</li>
    </ul>
  </div>

  <script>
    // ì „ì—­ ìƒíƒœ
    let currentTab = 'workflow';
    let nodes = {
      workflow: [],
      scenario: []
    };
    let connections = {
      workflow: [],
      scenario: []
    };
    let selectedNodeId = null;
    let draggedNode = null;
    let dragOffset = { x: 0, y: 0 };
    let connectingFrom = null;
    let tempConnection = null;
    let nodeIdCounter = 0;

    // íƒ­ ì „í™˜
    function switchTab(tabName) {
      currentTab = tabName;
      
      // íƒ­ ë²„íŠ¼ í™œì„±í™”
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // íƒ­ ì»¨í…ì¸  í‘œì‹œ
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabName + 'Tab').classList.add('active');
      
      updateStatus();
      redrawConnections();
    }

    // ì´ˆê¸° ë…¸ë“œ ìƒì„±
    function initializeNodes() {
      // ì›Œí¬í”Œë¡œìš° ë¹Œë” ì´ˆê¸° ë…¸ë“œ
      addNodeToCanvas('workflow', {
        type: 'start',
        label: 'ì‹œì‘',
        x: 100,
        y: 200
      });
      addNodeToCanvas('workflow', {
        type: 'ai-answer',
        label: 'AI ë‹µë³€',
        x: 400,
        y: 200,
        config: { prompt: 'ì•ˆë…•í•˜ì„¸ìš”. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?' }
      });
      addNodeToCanvas('workflow', {
        type: 'end',
        label: 'ì¢…ë£Œ',
        x: 700,
        y: 200
      });
      
      // ì´ˆê¸° ì—°ê²°
      connections.workflow.push({ from: 'node-0', to: 'node-1' });
      connections.workflow.push({ from: 'node-1', to: 'node-2' });
      
      // ì‹œë‚˜ë¦¬ì˜¤ í”Œë¡œìš° ì—ë””í„° ì´ˆê¸° ë…¸ë“œ
      addNodeToCanvas('scenario', {
        type: 'scenario-start',
        label: 'ECSì´ì»¤ë¨¸ìŠ¤ ë°˜í’ˆ ì•ˆë‚´ ìƒë‹´ì‚¬',
        x: 100,
        y: 200
      });
      addNodeToCanvas('scenario', {
        type: 'scenario-workflow',
        label: 'ECSì´ì»¤ë¨¸ìŠ¤ ë°˜í’ˆ ì•ˆë‚´ ì—”ë“œ ìˆ˜ì •',
        x: 400,
        y: 100
      });
      addNodeToCanvas('scenario', {
        type: 'scenario-workflow',
        label: 'ECSì´ì»¤ë¨¸ìŠ¤ ë°˜í’ˆ â†’ ë©”ì¸ ì—”ë“œ ìˆ˜ì •',
        x: 700,
        y: 300
      });
      addNodeToCanvas('scenario', {
        type: 'scenario-end',
        label: 'ë©”ì¸ ì•ˆë‚´ ê·¸ë£¹íŠ¸ í˜¸ì¶œ',
        x: 1000,
        y: 200
      });
      
      // ì´ˆê¸° ì—°ê²°
      connections.scenario.push({ from: 'node-3', to: 'node-4', label: 'ì „í™˜(loop)' });
      connections.scenario.push({ from: 'node-3', to: 'node-5', label: 'ë©”ì¸(main)' });
      connections.scenario.push({ from: 'node-4', to: 'node-6' });
      connections.scenario.push({ from: 'node-5', to: 'node-6' });
      
      redrawConnections();
      updateStatus();
    }

    // ë…¸ë“œ ì¶”ê°€
    function addNode(type) {
      const canvas = document.getElementById(currentTab + 'Content');
      const rect = canvas.getBoundingClientRect();
      
      addNodeToCanvas(currentTab, {
        type: type,
        label: getNodeLabel(type),
        x: 400 + Math.random() * 200,
        y: 200 + Math.random() * 200
      });
    }

    function addNodeToCanvas(tab, config) {
      const nodeId = 'node-' + (nodeIdCounter++);
      const node = {
        id: nodeId,
        type: config.type,
        label: config.label,
        x: config.x,
        y: config.y,
        config: config.config
      };
      
      nodes[tab].push(node);
      
      const nodeElement = createNodeElement(node);
      document.getElementById(tab + 'Content').appendChild(nodeElement);
      
      updateStatus();
      redrawConnections();
    }

    // ë…¸ë“œ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
    function createNodeElement(node) {
      const div = document.createElement('div');
      div.className = 'flow-node';
      div.id = node.id;
      div.style.left = node.x + 'px';
      div.style.top = node.y + 'px';
      
      const typeClass = getNodeTypeClass(node.type);
      const typeLabel = getNodeTypeLabel(node.type);
      
      div.innerHTML = `
        <div class="node-header" style="background: ${getNodeHeaderBg(node.type)}">
          <span class="node-type-badge ${typeClass}">${typeLabel}</span>
          <span class="node-label">${node.label}</span>
          <button class="node-delete" onclick="deleteNode('${node.id}')">âœ•</button>
        </div>
        <div class="node-body">
          ${getNodeBody(node)}
        </div>
        <div class="node-connector input" data-node-id="${node.id}" data-type="input"></div>
        <div class="node-connector output" data-node-id="${node.id}" data-type="output"></div>
      `;
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      div.addEventListener('mousedown', handleNodeMouseDown);
      div.addEventListener('click', (e) => {
        e.stopPropagation();
        selectNode(node.id);
      });
      
      // ì—°ê²°ì  ì´ë²¤íŠ¸
      const connectors = div.querySelectorAll('.node-connector');
      connectors.forEach(connector => {
        connector.addEventListener('mousedown', handleConnectorMouseDown);
      });
      
      return div;
    }

    // ë…¸ë“œ ì •ë³´ ë°˜í™˜
    function getNodeLabel(type) {
      const labels = {
        'start': 'ì‹œì‘',
        'ai-answer': 'AI ë‹µë³€',
        'state-change': 'ìƒíƒœ ë³€ê²½',
        'end': 'ì¢…ë£Œ',
        'scenario-start': 'ì‹œë‚˜ë¦¬ì˜¤ ì‹œì‘',
        'scenario-workflow': 'ì›Œí¬í”Œë¡œìš°',
        'scenario-end': 'ì‹œë‚˜ë¦¬ì˜¤ ì¢…ë£Œ'
      };
      return labels[type] || type;
    }

    function getNodeTypeClass(type) {
      if (type.includes('start')) return 'node-type-start';
      if (type.includes('end')) return 'node-type-end';
      if (type.includes('ai')) return 'node-type-ai';
      if (type.includes('state')) return 'node-type-state';
      if (type.includes('workflow')) return 'node-type-workflow';
      return 'node-type-ai';
    }

    function getNodeTypeLabel(type) {
      if (type.includes('start')) return 'START';
      if (type.includes('end')) return 'END';
      if (type === 'ai-answer') return 'AI ë‹µë³€';
      if (type === 'state-change') return 'ìƒíƒœ ë³€ê²½';
      if (type.includes('workflow')) return 'ìƒíƒœ ë³€ê²½';
      return 'NODE';
    }

    function getNodeHeaderBg(type) {
      if (type.includes('start')) return '#10b98115';
      if (type.includes('end')) return '#ef444415';
      if (type.includes('ai')) return '#3b82f615';
      if (type.includes('state')) return '#f59e0b15';
      if (type.includes('workflow')) return '#10b98115';
      return '#f9fafb';
    }

    function getNodeBody(node) {
      if (node.config && node.config.prompt) {
        return `
          <div><strong>í”„ë¡¬í”„íŠ¸:</strong></div>
          <div class="node-config">${node.config.prompt}</div>
        `;
      }
      if (node.type === 'state-change') {
        return `<div><strong>ìƒíƒœ:</strong> ëŒ€í™” ìƒíƒœ ë³€ê²½</div>`;
      }
      if (node.type === 'end' || node.type === 'scenario-end') {
        return `<div><strong>ì•¡ì…˜:</strong> ëŒ€í™” ì¢…ë£Œ</div>`;
      }
      return `<div style="color: #9ca3af;">ë…¸ë“œ ì„¤ì •</div>`;
    }

    // ë…¸ë“œ ë“œë˜ê·¸
    function handleNodeMouseDown(e) {
      if (e.target.classList.contains('node-connector')) return;
      if (e.target.classList.contains('node-delete')) return;
      
      e.preventDefault();
      const node = e.currentTarget;
      const rect = node.getBoundingClientRect();
      const canvas = node.parentElement;
      const canvasRect = canvas.getBoundingClientRect();
      
      draggedNode = node;
      dragOffset = {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      };
      
      node.classList.add('dragging');
      
      document.addEventListener('mousemove', handleNodeMouseMove);
      document.addEventListener('mouseup', handleNodeMouseUp);
    }

    function handleNodeMouseMove(e) {
      if (!draggedNode) return;
      
      const canvas = draggedNode.parentElement;
      const canvasRect = canvas.getBoundingClientRect();
      
      const x = e.clientX - canvasRect.left - dragOffset.x + canvas.scrollLeft;
      const y = e.clientY - canvasRect.top - dragOffset.y + canvas.scrollTop;
      
      draggedNode.style.left = Math.max(0, x) + 'px';
      draggedNode.style.top = Math.max(0, y) + 'px';
      
      // ë…¸ë“œ ë°ì´í„° ì—…ë°ì´íŠ¸
      const nodeId = draggedNode.id;
      const node = nodes[currentTab].find(n => n.id === nodeId);
      if (node) {
        node.x = parseInt(draggedNode.style.left);
        node.y = parseInt(draggedNode.style.top);
      }
      
      redrawConnections();
    }

    function handleNodeMouseUp(e) {
      if (draggedNode) {
        draggedNode.classList.remove('dragging');
        draggedNode = null;
      }
      
      document.removeEventListener('mousemove', handleNodeMouseMove);
      document.removeEventListener('mouseup', handleNodeMouseUp);
    }

    // ì—°ê²°ì  ì²˜ë¦¬
    function handleConnectorMouseDown(e) {
      e.stopPropagation();
      e.preventDefault();
      
      const connector = e.currentTarget;
      const nodeId = connector.dataset.nodeId;
      const type = connector.dataset.type;
      
      if (type === 'output') {
        // ì—°ê²° ì‹œì‘
        connectingFrom = nodeId;
        
        const canvas = document.getElementById(currentTab + 'Canvas');
        canvas.addEventListener('mousemove', handleConnectorMouseMove);
        canvas.addEventListener('mouseup', handleConnectorMouseUp);
      } else if (type === 'input' && connectingFrom) {
        // ì—°ê²° ì™„ë£Œ
        const toNodeId = nodeId;
        connections[currentTab].push({ from: connectingFrom, to: toNodeId });
        connectingFrom = null;
        tempConnection = null;
        redrawConnections();
        updateStatus();
      }
    }

    function handleConnectorMouseMove(e) {
      if (!connectingFrom) return;
      
      tempConnection = {
        x: e.clientX,
        y: e.clientY
      };
      
      redrawConnections();
    }

    function handleConnectorMouseUp(e) {
      connectingFrom = null;
      tempConnection = null;
      
      const canvas = document.getElementById(currentTab + 'Canvas');
      canvas.removeEventListener('mousemove', handleConnectorMouseMove);
      canvas.removeEventListener('mouseup', handleConnectorMouseUp);
      
      redrawConnections();
    }

    // ì—°ê²°ì„  ê·¸ë¦¬ê¸°
    function redrawConnections() {
      const svg = document.getElementById(currentTab + 'Svg');
      svg.innerHTML = '';
      
      const canvas = document.getElementById(currentTab + 'Canvas');
      const canvasRect = canvas.getBoundingClientRect();
      
      svg.setAttribute('width', canvas.scrollWidth);
      svg.setAttribute('height', canvas.scrollHeight);
      
      // ê¸°ì¡´ ì—°ê²°ì„  ê·¸ë¦¬ê¸°
      connections[currentTab].forEach(conn => {
        const fromNode = document.getElementById(conn.from);
        const toNode = document.getElementById(conn.to);
        
        if (!fromNode || !toNode) return;
        
        const fromRect = fromNode.getBoundingClientRect();
        const toRect = toNode.getBoundingClientRect();
        
        const x1 = fromRect.right - canvasRect.left + canvas.scrollLeft;
        const y1 = fromRect.top - canvasRect.top + fromRect.height / 2 + canvas.scrollTop;
        const x2 = toRect.left - canvasRect.left + canvas.scrollLeft;
        const y2 = toRect.top - canvasRect.top + toRect.height / 2 + canvas.scrollTop;
        
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        const d = `M ${x1} ${y1} C ${x1 + 100} ${y1}, ${x2 - 100} ${y2}, ${x2} ${y2}`;
        path.setAttribute('d', d);
        path.setAttribute('class', conn.label ? 'connection-line conditional' : 'connection-line normal');
        
        svg.appendChild(path);
        
        // í™”ì‚´í‘œ
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', x2);
        circle.setAttribute('cy', y2);
        circle.setAttribute('r', 4);
        circle.setAttribute('fill', conn.label ? '#06b6d4' : '#9ca3af');
        svg.appendChild(circle);
        
        // ë¼ë²¨
        if (conn.label) {
          const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          text.setAttribute('x', (x1 + x2) / 2);
          text.setAttribute('y', (y1 + y2) / 2 - 10);
          text.setAttribute('fill', '#6b7280');
          text.setAttribute('font-size', '12');
          text.setAttribute('font-weight', '600');
          text.setAttribute('text-anchor', 'middle');
          text.textContent = conn.label;
          svg.appendChild(text);
        }
      });
      
      // ì„ì‹œ ì—°ê²°ì„  ê·¸ë¦¬ê¸°
      if (connectingFrom && tempConnection) {
        const fromNode = document.getElementById(connectingFrom);
        if (fromNode) {
          const fromRect = fromNode.getBoundingClientRect();
          
          const x1 = fromRect.right - canvasRect.left + canvas.scrollLeft;
          const y1 = fromRect.top - canvasRect.top + fromRect.height / 2 + canvas.scrollTop;
          const x2 = tempConnection.x - canvasRect.left + canvas.scrollLeft;
          const y2 = tempConnection.y - canvasRect.top + canvas.scrollTop;
          
          const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          line.setAttribute('x1', x1);
          line.setAttribute('y1', y1);
          line.setAttribute('x2', x2);
          line.setAttribute('y2', y2);
          line.setAttribute('class', 'connection-line temp');
          
          svg.appendChild(line);
        }
      }
    }

    // ë…¸ë“œ ì„ íƒ
    function selectNode(nodeId) {
      selectedNodeId = nodeId;
      
      document.querySelectorAll('.flow-node').forEach(node => {
        node.classList.remove('selected');
      });
      
      const node = document.getElementById(nodeId);
      if (node) {
        node.classList.add('selected');
      }
      
      updateStatus();
    }

    // ë…¸ë“œ ì‚­ì œ
    function deleteNode(nodeId) {
      // ë…¸ë“œ ì œê±°
      const nodeIndex = nodes[currentTab].findIndex(n => n.id === nodeId);
      if (nodeIndex > -1) {
        nodes[currentTab].splice(nodeIndex, 1);
      }
      
      // ì—°ê²° ì œê±°
      connections[currentTab] = connections[currentTab].filter(
        conn => conn.from !== nodeId && conn.to !== nodeId
      );
      
      // DOM ì œê±°
      const nodeElement = document.getElementById(nodeId);
      if (nodeElement) {
        nodeElement.remove();
      }
      
      if (selectedNodeId === nodeId) {
        selectedNodeId = null;
      }
      
      updateStatus();
      redrawConnections();
    }

    // ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateStatus() {
      document.getElementById('nodeCount').textContent = 
        `ë…¸ë“œ: ${nodes[currentTab].length}ê°œ`;
      document.getElementById('connectionCount').textContent = 
        `ì—°ê²°: ${connections[currentTab].length}ê°œ`;
      
      if (selectedNodeId) {
        const node = nodes[currentTab].find(n => n.id === selectedNodeId);
        document.getElementById('selectedNode').textContent = 
          `ì„ íƒ: ${node ? node.label : 'ì—†ìŒ'}`;
      } else {
        document.getElementById('selectedNode').textContent = 'ì„ íƒ: ì—†ìŒ';
      }
    }

    // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
    function resetCanvas() {
      if (confirm('í˜„ì¬ íƒ­ì˜ ëª¨ë“  ë…¸ë“œì™€ ì—°ê²°ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        nodes[currentTab] = [];
        connections[currentTab] = [];
        document.getElementById(currentTab + 'Content').innerHTML = '';
        selectedNodeId = null;
        updateStatus();
        redrawConnections();
      }
    }

    // ì €ì¥
    function saveFlow() {
      const data = {
        tab: currentTab,
        nodes: nodes[currentTab],
        connections: connections[currentTab]
      };
      
      console.log('Flow Data:', data);
      alert('í”Œë¡œìš°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n(ì½˜ì†”ì—ì„œ ë°ì´í„°ë¥¼ í™•ì¸í•˜ì„¸ìš”)');
    }

    // ë„ì›€ë§ í† ê¸€
    function toggleHelp() {
      const panel = document.getElementById('helpPanel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Delete' && selectedNodeId) {
        deleteNode(selectedNodeId);
      }
      if (e.key === 'Escape') {
        connectingFrom = null;
        tempConnection = null;
        redrawConnections();
      }
    });

    // ìº”ë²„ìŠ¤ ìŠ¤í¬ë¡¤ ì‹œ ì—°ê²°ì„  ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    document.querySelectorAll('.canvas').forEach(canvas => {
      canvas.addEventListener('scroll', () => {
        if (canvas.id === currentTab + 'Canvas') {
          redrawConnections();
        }
      });
    });

    // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ì—°ê²°ì„  ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    window.addEventListener('resize', redrawConnections);

    // íŒ”ë ˆíŠ¸ ì•„ì´í…œ ë“œë˜ê·¸ ì‹œì‘
    document.querySelectorAll('.node-palette-item').forEach(item => {
      item.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('nodeType', item.dataset.nodeType);
      });
    });

    // ìº”ë²„ìŠ¤ì— ë“œë¡­
    document.querySelectorAll('.canvas-content').forEach(content => {
      content.addEventListener('dragover', (e) => {
        e.preventDefault();
      });
      
      content.addEventListener('drop', (e) => {
        e.preventDefault();
        const nodeType = e.dataTransfer.getData('nodeType');
        
        if (nodeType) {
          const rect = content.getBoundingClientRect();
          const canvas = content.parentElement;
          const x = e.clientX - rect.left + canvas.scrollLeft;
          const y = e.clientY - rect.top + canvas.scrollTop;
          
          addNodeToCanvas(currentTab, {
            type: nodeType,
            label: getNodeLabel(nodeType),
            x: x - 140,
            y: y - 50
          });
        }
      });
    });

    // ì´ˆê¸°í™”
    window.addEventListener('load', () => {
      initializeNodes();
      setTimeout(() => {
        document.getElementById('helpPanel').style.display = 'block';
      }, 500);
    });
  </script>
</body>
</html>

